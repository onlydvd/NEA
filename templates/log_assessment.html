{% extends "base_page.html" %}

{% block head %}
    <title>Studsight - Log Assessment</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='log_assessment.css') }}">
{% endblock %}

{% block body %}
    <!-- Top bar -->
    <div class="menu-bar">
        <div class="back">
            <a href="{{ url_for('assessments', student_id=student[0]) }}">Back</a>
        </div>
        <h1>Log Assessment</h1>
    </div>

    <!-- Page layout -->
    <div class="page">

        <!-- Student card -->
        <section class="card student-card">
            <div class="student-left">
                <img src="{{ url_for('static', filename='Profile.png') }}" alt="Student Photo" class="student-photo">
            </div>

            <div class="student-right">
                <h2 class="student-name">{{ student[1] }} {{ student[2] }}</h2>
                <p class="student-sub">
                    Student ID: <span class="pill">{{ student[0] }}</span>
                </p>
            </div>
        </section>

        <!-- Form Section -->
        <section class="card">
            <div class="card-header">
                <h3>Create New Assessment Record</h3>
                <p>Fill in the assessment details below</p>
            </div>

            <!-- Flash messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" class="assessment-form">
                <!-- Subject Selection Dropdown -->
                <!-- Students can only log assessments for their assigned subjects -->
                <div class="form-group">
                    <label for="subject_id">Subject</label>
                    <select id="subject_id" name="subject_id" required>
                        <option value="">-- Select Subject --</option>
                        {% for subject_id, subject_name in subjects %}
                            <option value="{{ subject_id }}">{{ subject_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="type">Assessment Type</label>
                    <select id="type" name="type" required>
                        <option value="">-- Select Type --</option>
                        <option value="Test">Endpoint</option>
                        <option value="Exam">Midpoint</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="date">Date</label>
                    <input type="date" id="date" name="date" required>
                    <small class="help-text">Date of assessment (within past 2 years)</small>
                </div>

                <!-- Score Input Field -->
                <!-- Score must be a percentage between 0 and 100 -->
                <!-- Decimal values (e.g., 85.5) are supported for more precise grading -->
                <div class="form-group">
                    <label for="score">Score</label>
                    <input type="number" id="score" name="score" step="0.01" placeholder="Enter score" max="100" min="0" required>
                    <small class="help-text">Score percentage (0-100)</small>
                </div>

                <!-- Form Action Buttons -->
                <!-- Submit button saves the assessment; Cancel button returns without saving -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Log Assessment</button>
                    <a href="{{ url_for('assessments', student_id=student[0]) }}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </section>

    </div>

    <script>
        // Initialize date input restrictions on page load
        // This ensures users cannot select dates outside the valid range
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('date');
            const today = new Date();
            
            // Calculate date 2 years ago to set the minimum allowed date
            // Students' assessments cannot be older than 2 years
            const twoYearsAgo = new Date(today);
            twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
            
            // Set minimum date to 2 years ago (HTML5 date validation)
            const minDateString = twoYearsAgo.toISOString().split('T')[0];
            dateInput.setAttribute('min', minDateString);
            
            // Set maximum date to today (cannot log future assessments)
            const todayString = today.toISOString().split('T')[0];
            dateInput.setAttribute('max', todayString);
            
            // Add form submission validation to catch any client-side date issues
            // This provides immediate user feedback before server processing
            document.querySelector('.assessment-form').addEventListener('submit', function(e) {
                const selectedDate = new Date(dateInput.value);
                
                // Check if date is within the valid range (between 2 years ago and today)
                if (selectedDate < twoYearsAgo) {
                    // Prevent form submission if date is too old
                    e.preventDefault();
                    alert(`Assessment date cannot be before ${minDateString}. Please select a date from the past 2 years.`);
                    dateInput.focus();
                    return false;
                } else if (selectedDate > today) {
                    // Prevent form submission if date is in the future
                    e.preventDefault();
                    alert(`Assessment date cannot be in the future. Please select today or an earlier date.`);
                    dateInput.focus();
                    return false;
                }
            });
        });
    </script>
{% endblock %}
